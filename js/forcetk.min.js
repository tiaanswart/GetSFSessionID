/*
 * Copyright (c) 2011, salesforce.com, inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * Redistributions of source code must retain the above copyright notice, this list of conditions and the
 * following disclaimer.
 *
 * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and
 * the following disclaimer in the documentation and/or other materials provided with the distribution.
 *
 * Neither the name of salesforce.com, inc. nor the names of its contributors may be used to endorse or
 * promote products derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
 * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
 * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */

/* JavaScript library to wrap REST API on Visualforce. Leverages Ajax Proxy
 * (see http://bit.ly/sforce_ajax_proxy for details).
 *
 * Note that you must add the REST endpoint hostname for your instance (i.e. 
 * https://na1.salesforce.com/ or similar) as a remote site - in the admin
 * console, go to Your Name | Setup | Security Controls | Remote Site Settings
 */

/*jslint browser: true*/
/*global alert, Blob, $, jQuery*/
var forcetk=window.forcetk;void 0===forcetk&&(forcetk={}),void 0===forcetk.Client&&(void 0===window.$j&&($j=$),forcetk.Client=function(e,t,s){this.clientId=e,this.loginUrl=t||"https://login.salesforce.com/",void 0===s||null===s?("file:"===location.protocol?this.proxyUrl=null:this.proxyUrl=location.protocol+"//"+location.hostname+"/services/proxy",this.authzHeader="Authorization"):(this.proxyUrl=s,this.authzHeader="X-Authorization"),this.refreshToken=null,this.sessionId=null,this.apiVersion=null,this.instanceUrl=null,this.asyncAjax=!0},forcetk.Client.prototype.setRefreshToken=function(e){this.refreshToken=e},forcetk.Client.prototype.refreshAccessToken=function(e,t){var s=this,r=this.loginUrl+"/services/oauth2/token";return $j.ajax({type:"POST",url:null!==this.proxyUrl?this.proxyUrl:r,cache:!1,processData:!1,data:"grant_type=refresh_token&client_id="+this.clientId+"&refresh_token="+this.refreshToken,success:e,error:t,dataType:"json",beforeSend:function(e){null!==s.proxyUrl&&e.setRequestHeader("SalesforceProxy-Endpoint",r)}})},forcetk.Client.prototype.setSessionToken=function(e,t,s){if(this.sessionId=e,this.apiVersion=void 0===t||null===t?"v27.0":t,void 0===s||null==s){var r=location.hostname.split("."),o=null;o=4==r.length&&"my"===r[1]?r[0]+"."+r[1]:3==r.length?r[0]:r[1],this.instanceUrl="https://"+o+".salesforce.com"}else this.instanceUrl=s},forcetk.Client.prototype.ajax=function(e,t,s,r,o,n){var i=this,a=this.instanceUrl+"/services/data"+e;return $j.ajax({type:r||"GET",async:this.asyncAjax,url:null!==this.proxyUrl?this.proxyUrl:a,contentType:"DELETE"==r?null:"application/json",cache:!1,processData:!1,data:o,success:t,error:!this.refreshToken||n?s:function(n,a,c){401===n.status?i.refreshAccessToken(function(n){i.setSessionToken(n.access_token,null,n.instance_url),i.ajax(e,t,s,r,o,!0)},s):s(n,a,c)},dataType:"json",beforeSend:function(e){null!==i.proxyUrl&&e.setRequestHeader("SalesforceProxy-Endpoint",a),e.setRequestHeader(i.authzHeader,"OAuth "+i.sessionId),e.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+i.apiVersion)}})},forcetk.Client.prototype.getChatterFile=function(e,t,s,r,o){var n=this,i=this.instanceUrl+e,a=new XMLHttpRequest;a.open("GET",null!==this.proxyUrl?this.proxyUrl:i,!0),a.responseType="arraybuffer",a.setRequestHeader(n.authzHeader,"OAuth "+n.sessionId),a.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+n.apiVersion),null!==this.proxyUrl&&a.setRequestHeader("SalesforceProxy-Endpoint",i),a.onreadystatechange=function(){if(4==a.readyState)if(200==a.status)try{s(a.response)}catch(e){alert("Error reading the response: "+e.toString())}else 401!=a.status||o?r(a,a.statusText,a.response):n.refreshAccessToken(function(o){n.setSessionToken(o.access_token,null,o.instance_url),n.getChatterFile(e,t,s,r,!0)},r)},a.send()},forcetk.Client.prototype.apexrest=function(e,t,s,r,o,n,i){var a=this,c=this.instanceUrl+"/services/apexrest"+e;return $j.ajax({type:r||"GET",async:this.asyncAjax,url:null!==this.proxyUrl?this.proxyUrl:c,contentType:"application/json",cache:!1,processData:!1,data:o,success:t,error:!this.refreshToken||i?s:function(i,c,l){401===i.status?a.refreshAccessToken(function(i){a.setSessionToken(i.access_token,null,i.instance_url),a.apexrest(e,t,s,r,o,n,!0)},s):s(i,c,l)},dataType:"json",beforeSend:function(e){null!==a.proxyUrl&&e.setRequestHeader("SalesforceProxy-Endpoint",c),null===n&&(n={});for(paramName in n)e.setRequestHeader(paramName,n[paramName]);e.setRequestHeader(a.authzHeader,"OAuth "+a.sessionId),e.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+a.apiVersion)}})},forcetk.Client.prototype.currentUser=function(e,t){return this.ajax("/"+this.apiVersion+"/chatter/users/me/",e,t)},forcetk.Client.prototype.versions=function(e,t){return this.ajax("/",e,t)},forcetk.Client.prototype.resources=function(e,t){return this.ajax("/"+this.apiVersion+"/",e,t)},forcetk.Client.prototype.describeGlobal=function(e,t){return this.ajax("/"+this.apiVersion+"/sobjects/",e,t)},forcetk.Client.prototype.metadata=function(e,t,s){return this.ajax("/"+this.apiVersion+"/sobjects/"+e+"/",t,s)},forcetk.Client.prototype.describe=function(e,t,s){return this.ajax("/"+this.apiVersion+"/sobjects/"+e+"/describe/",t,s)},forcetk.Client.prototype.create=function(e,t,s,r){return this.ajax("/"+this.apiVersion+"/sobjects/"+e+"/",s,r,"POST",JSON.stringify(t))},forcetk.Client.prototype.retrieve=function(e,t,s,r,o){4==arguments.length&&(o=r,r=s,s=null);var n=s?"?fields="+s:"";this.ajax("/"+this.apiVersion+"/sobjects/"+e+"/"+t+n,r,o)},forcetk.Client.prototype.upsert=function(e,t,s,r,o,n){return this.ajax("/"+this.apiVersion+"/sobjects/"+e+"/"+t+"/"+s+"?_HttpMethod=PATCH",o,n,"POST",JSON.stringify(r))},forcetk.Client.prototype.update=function(e,t,s,r,o){return this.ajax("/"+this.apiVersion+"/sobjects/"+e+"/"+t+"?_HttpMethod=PATCH",r,o,"POST",JSON.stringify(s))},forcetk.Client.prototype.del=function(e,t,s,r){return this.ajax("/"+this.apiVersion+"/sobjects/"+e+"/"+t,s,r,"DELETE")},forcetk.Client.prototype.query=function(e,t,s){return this.ajax("/"+this.apiVersion+"/query?q="+escape(e),t,s)},forcetk.Client.prototype.queryMore=function(e,t,s){var r=e.indexOf("services/data");return r>-1&&(e=e.substr(r+"services/data".length)),this.ajax(e,t,s)},forcetk.Client.prototype.search=function(e,t,s){return this.ajax("/"+this.apiVersion+"/search?q="+escape(e),t,s)});